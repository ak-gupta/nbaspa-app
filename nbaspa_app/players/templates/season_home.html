{% extends 'layout.html' %}

{% block header %}
    <link
        rel="stylesheet"
        href="{{ url_for('players_bp.' + config['STATIC_FOLDER'], filename='dist/css/player.css') }}"
        type='text/css'>
{% endblock %}

{% block content %}
    <br>
    <h4 class="title">{{ season }} Summary</h4>
    <p class="subtitle">The following graph can plot the SPA+ performance of any player that played 50+ games in {{ season }}.</p>
    <br>
    <div class="columns">
        <div class="column is-2">
            <div class="field">
                <div class="select is-multiple">
                    <select multiple id="playerFilter" size="10"></select>
                </div>
            </div>
            <div class="field">
                <button class="button is-link" id="submit">Graph</button>
            </div>
        </div>
        <div class="column is-6">
            <div id="compareGraph" style="text-align: center"></div>
        </div>
        <div class="column is-4" id="playerList"></div>
    </div>
{% endblock %}

{% block jsScript %}
    <script type="text/javascript" src="{{ url_for('players_bp.' + config['STATIC_FOLDER'], filename='dist/js/compare/graph.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('players_bp.' + config['STATIC_FOLDER'], filename='dist/js/compare/div.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('players_bp.' + config['STATIC_FOLDER'], filename='dist/js/io.js') }}"></script>

    <script>
        let topPlayers = null;
        let defaultSelect = null;
        let defaultFiltered = null;
        let displayInfo = null;
        loadPlayerIndex(
            Season="{{ season }}",
            function (result) {
                // Set the displayInfo result
                displayInfo = result
                d3.select("#playerFilter")
                    .selectAll("select")
                    .data(result)
                    .enter()
                    .insert("option")
                    .attr("value", d => d.PERSON_ID)
                    .text(d => d.DISPLAY_FIRST_LAST)
            }
        );
        loadTopPlayers(
            Season="{{ season }}",
            function (result) {
                topPlayers = result
                defaultSelect = result.map(obs => obs.PLAYER_ID).slice(0, 5);
                defaultFiltered = loadCompareData(playerList=defaultSelect, Season="{{ season }}")
                compareChart(playerData=defaultFiltered, info=displayInfo, tag="#compareGraph")
                playerDivs(playerList=defaultFiltered, info=displayInfo, tag="#playerList")
            }
        )


        document.getElementById('submit').onclick = function() {
            var selected = [];
            for (var option of document.getElementById('playerFilter').options) {
                if (option.selected) {
                    selected.push(parseInt(option.value));
                }
            }
            d3.select("#compareGraph").selectAll("svg").remove();
            d3.select("#compareGraph").selectAll("div").remove();
            d3.select("#playerList").selectAll("div").remove();
            var newFiltered = loadCompareData(
                playerList=selected,
                Season="{{ season }}"
            )
            playerDivs(playerList=newFiltered, info=displayInfo, tag="#playerList")
            compareChart(playerData=newFiltered, info=displayInfo, tag="#compareGraph")
        }
    </script>
{% endblock %}